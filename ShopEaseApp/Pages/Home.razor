@page "/"
@using ShopEaseApp.Services
@inject CartService CartService
@implements IDisposable

<PageTitle>ShopEase</PageTitle>

<h1>ShopEase</h1>

<div class="row">
	<div class="col-md-8">
		<h2>Products</h2>
		<div class="product-grid">
			@foreach (var product in Products)
			{
				<ProductCard @key="product.ProductID" Product="product" OnAddToCart="HandleAddToCart" />
			}
		</div>
	</div>
	<div class="col-md-4">
		<h2>Cart</h2>
		<Cart Items="CartService.Items" Total="CartService.Total" OnRemove="HandleRemoveFromCart" OnClear="HandleClearCart" />
	</div>
</div>

@code {
	private readonly List<Product> Products = new()
	{
		new Product { ProductID = 1, Name = "Laptop", Price = 999.99m, Category = "Electronics" },
		new Product { ProductID = 2, Name = "Headphones", Price = 149.50m, Category = "Electronics" },
		new Product { ProductID = 3, Name = "Coffee Maker", Price = 79.99m, Category = "Home" }
	};

	protected override void OnInitialized()
	{
		CartService.OnChange += HandleCartChanged;
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender)
		{
			return;
		}

		await CartService.InitializeAsync();
	}

	private Task HandleAddToCart(Product product)
		=> CartService.AddProductAsync(product);

	private Task HandleRemoveFromCart(int productId)
		=> CartService.RemoveProductAsync(productId);

	private Task HandleClearCart()
		=> CartService.ClearAsync();

	private void HandleCartChanged()
	{
		InvokeAsync(StateHasChanged);
	}

	public void Dispose()
	{
		CartService.OnChange -= HandleCartChanged;
	}
}
